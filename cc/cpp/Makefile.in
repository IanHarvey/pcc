#	$Id$
#
# Makefile.in for cpp
#
VPATH=@srcdir@
srcdir=@srcdir@
top_srcdir=@top_srcdir@
builddir=@builddir@
top_builddir=@top_builddir@
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libexecdir = @libexecdir@
datarootdir = @datarootdir@
mandir = @mandir@
CC = @CC@
EXEEXT = @EXEEXT@
CFLAGS = @CFLAGS@ @ADD_CFLAGS@
CPPFLAGS = @CPPFLAGS@ @ADD_CPPFLAGS@ \
	-I$(srcdir) -I$(top_builddir) -I$(builddir) -I$(MIPDIR) -I$(MDIR)
LIBS = @LIBS@
LDFLAGS = @LDFLAGS@
YACC = @YACC@
YFLAGS = @YFLAGS@
INSTALL = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@
TARGMACH = @targmach@

MIPDIR=$(top_srcdir)/mip
MDIR=$(top_srcdir)/arch/$(TARGMACH)

DEST=@BINPREFIX@cpp$(EXEEXT)

all: $(DEST)

OBJS=	compat.o cpp.o cpy.o token.o
HDRS=	cpp.h

$(OBJS): $(HDRS) cpy.c

compat.o: $(MIPDIR)/compat.c
	$(CC) $(CFLAGS) $(CPPFLAGS) -c -o $@ $(MIPDIR)/compat.c

cpp.o: $(srcdir)/cpp.c
	$(CC) $(CFLAGS) $(CPPFLAGS) -c -o $@ $(srcdir)/cpp.c

cpy.c: $(srcdir)/cpy.y
	$(YACC) $(YFLAGS) -d $(srcdir)/cpy.y
	mv -f y.tab.c cpy.c
	mv -f y.tab.h cpy.h

cpy.o: cpy.c
	$(CC) $(CFLAGS) $(CPPFLAGS) -c -o $@ cpy.c

token.o: $(srcdir)/token.c
	$(CC) $(CFLAGS) $(CPPFLAGS) -c -o $@ $(srcdir)/token.c

$(DEST): $(OBJS)
	$(CC) $(LDFLAGS) $(OBJS) -o $@ $(LIBS)

test:
	./cpp < tests/test1 > tests/run1
	cmp tests/run1 tests/res1
	./cpp < tests/test2 > tests/run2
	cmp tests/run2 tests/res2
	./cpp < tests/test3 > tests/run3
	cmp tests/run3 tests/res3
	./cpp < tests/test4 > tests/run4
	cmp tests/run4 tests/res4
	./cpp < tests/test5 > tests/run5
	cmp tests/run5 tests/res5
	./cpp < tests/test6 > tests/run6
	cmp tests/run6 tests/res6
	./cpp < tests/test7 > tests/run7
	cmp tests/run7 tests/res7
	./cpp < tests/test8 > tests/run8
	cmp tests/run8 tests/res8
	./cpp < tests/test9 > tests/run9
	cmp tests/run9 tests/res9
	./cpp < tests/test10 > tests/run10
	cmp tests/run10 tests/res10
	./cpp < tests/test11 > tests/run11
	cmp tests/run11 tests/res11
	./cpp < tests/test12 > tests/run12
	cmp tests/run12 tests/res12
	./cpp < tests/test13 > tests/run13
	cmp tests/run13 tests/res13
	./cpp < tests/test14 > tests/run14
	cmp tests/run14 tests/res14
	./cpp < tests/test15 > tests/run15
	cmp tests/run15 tests/res15
	./cpp -C < tests/test15 > tests/run15C
	cmp tests/run15C tests/res15C
	./cpp < tests/test16 > tests/run16
	cmp tests/run16 tests/res16
	./cpp -C < tests/test16 > tests/run16C
	cmp tests/run16C tests/res16C
	./cpp < tests/test17 > tests/run17
	cmp tests/run17 tests/res17

install:
	test -z "$(DESTDIR)$(libexecdir)" || mkdir -p "$(DESTDIR)$(libexecdir)"
	$(INSTALL_PROGRAM) $(DEST) $(DESTDIR)$(libexecdir)
	test -z "$(DESTDIR)$(mandir)/man1" || mkdir -p "$(DESTDIR)$(mandir)/man1"
	$(INSTALL_DATA) $(srcdir)/cpp.1 $(DESTDIR)$(mandir)/man1/$(DEST).1

clean:
	rm -f $(OBJS) $(DEST) cpy.[ch] y.tab.[ch] tests/run*

distclean: clean
	rm -f Makefile
